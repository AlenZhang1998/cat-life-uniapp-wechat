{"version":3,"file":"auth.js","sources":["utils/auth.ts"],"sourcesContent":["import { ref } from 'vue'\n\nconst TOKEN_KEY = 'token'\nconst PROFILE_KEY = 'userProfile'\n\ntype StoredProfile = Record<string, any> | null\n\nconst isLoggedIn = ref(false)\n\nconst readTokenFromStorage = (): string => {\n  try {\n    const token = uni.getStorageSync(TOKEN_KEY)\n    return typeof token === 'string' ? token : ''\n  } catch (error) {\n    console.warn('读取 token 失败', error)\n    return ''\n  }\n}\n\nconst readProfileFromStorage = (): StoredProfile => {\n  try {\n    const stored = uni.getStorageSync(PROFILE_KEY)\n    if (!stored) {\n      return null\n    }\n    if (typeof stored === 'string') {\n      try {\n        return JSON.parse(stored)\n      } catch (error) {\n        console.warn('解析用户信息失败', error)\n        return null\n      }\n    }\n    return stored as StoredProfile\n  } catch (error) {\n    console.warn('读取用户信息失败', error)\n    return null\n  }\n}\n\nconst resolveLoginState = () => {\n  const token = readTokenFromStorage()\n  if (token) {\n    return true\n  }\n  const profile = readProfileFromStorage()\n  return !!(profile && profile.name)\n}\n\nconst refreshLoginState = () => {\n  isLoggedIn.value = resolveLoginState()\n  return isLoggedIn.value\n}\n\nconst setStoredToken = (token?: string) => {\n  try {\n    if (token) {\n      uni.setStorageSync(TOKEN_KEY, token)\n    } else {\n      uni.removeStorageSync(TOKEN_KEY)\n    }\n  } catch (error) {\n    console.warn('写入 token 失败', error)\n  }\n  refreshLoginState()\n}\n\nconst setStoredProfile = (profile?: StoredProfile) => {\n  try {\n    if (profile) {\n      uni.setStorageSync(PROFILE_KEY, profile)\n    } else {\n      uni.removeStorageSync(PROFILE_KEY)\n    }\n  } catch (error) {\n    console.warn('写入用户信息失败', error)\n  }\n  refreshLoginState()\n}\n\nrefreshLoginState()\n\nexport const useAuth = () => ({\n  isLoggedIn,\n  refreshLoginState,\n  setStoredToken,\n  setStoredProfile,\n  getStoredProfile: readProfileFromStorage\n})\n"],"names":["ref","uni"],"mappings":";;AAEA,MAAM,YAAY;AAClB,MAAM,cAAc;AAIpB,MAAM,aAAaA,cAAAA,IAAI,KAAK;AAE5B,MAAM,uBAAuB,MAAc;AACrC,MAAA;AACI,UAAA,QAAQC,cAAAA,MAAI,eAAe,SAAS;AACnC,WAAA,OAAO,UAAU,WAAW,QAAQ;AAAA,WACpC,OAAO;AACdA,kBAAA,MAAa,MAAA,QAAA,uBAAA,eAAe,KAAK;AAC1B,WAAA;AAAA,EACT;AACF;AAEA,MAAM,yBAAyB,MAAqB;AAC9C,MAAA;AACI,UAAA,SAASA,cAAAA,MAAI,eAAe,WAAW;AAC7C,QAAI,CAAC,QAAQ;AACJ,aAAA;AAAA,IACT;AACI,QAAA,OAAO,WAAW,UAAU;AAC1B,UAAA;AACK,eAAA,KAAK,MAAM,MAAM;AAAA,eACjB,OAAO;AACdA,sBAAA,MAAA,MAAA,QAAA,uBAAa,YAAY,KAAK;AACvB,eAAA;AAAA,MACT;AAAA,IACF;AACO,WAAA;AAAA,WACA,OAAO;AACdA,kBAAA,MAAA,MAAA,QAAA,uBAAa,YAAY,KAAK;AACvB,WAAA;AAAA,EACT;AACF;AAEA,MAAM,oBAAoB,MAAM;AAC9B,QAAM,QAAQ;AACd,MAAI,OAAO;AACF,WAAA;AAAA,EACT;AACA,QAAM,UAAU;AACT,SAAA,CAAC,EAAE,WAAW,QAAQ;AAC/B;AAEA,MAAM,oBAAoB,MAAM;AAC9B,aAAW,QAAQ;AACnB,SAAO,WAAW;AACpB;AAEA,MAAM,iBAAiB,CAAC,UAAmB;AACrC,MAAA;AACF,QAAI,OAAO;AACLA,oBAAAA,MAAA,eAAe,WAAW,KAAK;AAAA,IAAA,OAC9B;AACLA,0BAAI,kBAAkB,SAAS;AAAA,IACjC;AAAA,WACO,OAAO;AACdA,kBAAA,MAAa,MAAA,QAAA,uBAAA,eAAe,KAAK;AAAA,EACnC;AACkB;AACpB;AAEA,MAAM,mBAAmB,CAAC,YAA4B;AAChD,MAAA;AACF,QAAI,SAAS;AACPA,oBAAAA,MAAA,eAAe,aAAa,OAAO;AAAA,IAAA,OAClC;AACLA,0BAAI,kBAAkB,WAAW;AAAA,IACnC;AAAA,WACO,OAAO;AACdA,kBAAA,MAAA,MAAA,QAAA,uBAAa,YAAY,KAAK;AAAA,EAChC;AACkB;AACpB;AAEA;AAEO,MAAM,UAAU,OAAO;AAAA,EAC5B;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA,kBAAkB;AACpB;;"}
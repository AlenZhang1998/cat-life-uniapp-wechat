{"version":3,"file":"location.js","sources":["utils/location.ts"],"sourcesContent":["import { axios } from '@/utils/request';\n\ntype ReverseGeocodeResult = {\n  city: string;\n  province?: string;\n  address?: string;\n};\n\nexport type LocatedCity = {\n  city: string;\n  latitude: number;\n  longitude: number;\n  province?: string;\n  address?: string;\n};\n\nconst TENCENT_MAP_KEY =\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore uni-app 会在编译阶段注入 import.meta.env\n  (import.meta?.env?.VITE_TENCENT_MAP_KEY as string | undefined) || '';\n\nconst GEOCODER_ENDPOINT = 'https://apis.map.qq.com/ws/geocoder/v1';\n\nconst CITY_NAME_MATCHER =\n  /(北京市|天津市|上海市|重庆市|[\\u4e00-\\u9fa5]+?(?:自治区|自治州|地区|盟|市|区|县))/u;\nconst PROVINCE_PREFIX_MATCHER = /^[\\u4e00-\\u9fa5]+?(?:省|自治区|特别行政区)/u;\nconst PROVINCE_SUFFIX_MATCHER = /(省|特别行政区)$/u;\n\nexport const requestLocation = () =>\n  new Promise<UniApp.GetLocationSuccess>((resolve, reject) => {\n    const tryOnce = (highAccuracy: boolean) => {\n      uni.getLocation({\n        type: 'gcj02',\n        isHighAccuracy: highAccuracy,\n        highAccuracyExpireTime: 3000,\n        success: (pos) => {\n          console.log('[requestLocation] success', pos);\n          resolve(pos);\n        },\n        fail: (err: any) => {\n          console.warn('[requestLocation] fail', err);\n          // 第一次高精度失败，再用普通模式试一次\n          if (highAccuracy && (err.errCode === 404 || err.errCode === 2)) {\n            tryOnce(false);\n          } else {\n            reject(err);\n          }\n        },\n      });\n    };\n\n    tryOnce(true);\n  });\n\nexport const chooseLocationManually = () =>\n  new Promise<UniApp.ChooseLocationSuccess | null>((resolve) => {\n    uni.chooseLocation({\n      success: (res) => resolve(res),\n      fail: () => resolve(null),\n    });\n  });\n\nexport const extractCityFromText = (text?: string | null) => {\n  if (!text) return null;\n  const match = text.match(CITY_NAME_MATCHER);\n  if (!match) return null;\n  const raw = match[1];\n  const withoutPrefix = raw.replace(PROVINCE_PREFIX_MATCHER, '');\n  const normalized = withoutPrefix || raw;\n  return normalized.replace(PROVINCE_SUFFIX_MATCHER, '');\n};\n\nexport const normalizeCityName = (text?: string | null) => {\n  if (!text) return '';\n  const normalized = extractCityFromText(text);\n  return (normalized ?? text).trim();\n};\n\nexport const reverseGeocodeByTencent = async (\n  latitude: number,\n  longitude: number\n): Promise<ReverseGeocodeResult | null> => {\n  console.log(83, '[reverseGeocodeByTencent] KEY =', TENCENT_MAP_KEY);\n  if (!TENCENT_MAP_KEY) {\n    return null;\n  }\n\n  try {\n    const response = await axios.request<{\n      status: number;\n      result?: {\n        address: string;\n        ad_info: {\n          city: string;\n          province: string;\n        };\n        formatted_addresses?: {\n          recommend?: string;\n        };\n      };\n    }>({\n      url: GEOCODER_ENDPOINT,\n      method: 'GET',\n      data: {\n        key: TENCENT_MAP_KEY,\n        location: `${latitude},${longitude}`,\n        get_poi: 0,\n      },\n      showErrorToast: false,\n    });\n\n    if (response.status === 0 && response.result) {\n      const {\n        result: { address, ad_info },\n      } = response;\n      return {\n        city: ad_info.city.replace(/(市|地区|盟)$/u, ''),\n        province: ad_info.province,\n        address,\n      };\n    }\n  } catch (error) {\n    console.warn('reverseGeocodeByTencent failed', error);\n  }\n  return null;\n};\n\nexport const locateCityByGPS = async (): Promise<LocatedCity | null> => {\n  try {\n    const { latitude, longitude } = await requestLocation();\n    const geocode = await reverseGeocodeByTencent(latitude, longitude);\n    if (geocode) {\n      return {\n        city: geocode.city,\n        latitude,\n        longitude,\n        province: geocode.province,\n        address: geocode.address,\n      };\n    }\n  } catch (error) {\n    console.warn('locateCityByGPS failed', error);\n  }\n  return null;\n};\n\nexport const chooseCityFromMap = async (): Promise<LocatedCity | null> => {\n  const selection = await chooseLocationManually();\n  console.log(149, 'selection = ', selection);\n  if (!selection) return null;\n\n  const cityName =\n    extractCityFromText(selection.address) ??\n    extractCityFromText(selection.name);\n\n  return {\n    city: cityName || selection.name,\n    latitude: selection.latitude,\n    longitude: selection.longitude,\n    address: selection.address,\n  };\n};\n\nexport const ensureLocationAuth = () =>\n  new Promise<void>((resolve, reject) => {\n    uni.getSetting({\n      success(setting) {\n        if (setting.authSetting?.['scope.userLocation']) {\n          resolve();\n          return;\n        }\n\n        uni.authorize({\n          scope: 'scope.userLocation',\n          success: () => resolve(),\n          fail: () => {\n            uni.showModal({\n              title: '需要定位权限',\n              content: '开启定位权限以使用自动定位功能',\n              confirmText: '去开启',\n              success(res) {\n                if (res.confirm) {\n                  uni.openSetting({});\n                }\n              },\n            });\n            reject(new Error('user denied location scope'));\n          },\n        });\n      },\n      fail: (err) => reject(err),\n    });\n  });\n"],"names":["uni","axios"],"mappings":"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"}
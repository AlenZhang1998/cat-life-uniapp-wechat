{"version":3,"file":"request.js","sources":["utils/request.ts"],"sourcesContent":["export type RequestOptions<T = any> = Omit<\n  UniApp.RequestOptions,\n  'success' | 'fail' | 'complete'\n> & {\n  showErrorToast?: boolean;\n  baseURL?: string;\n};\n\ntype RequestSuccessResult<T = any> = Omit<\n  UniApp.RequestSuccessCallbackResult,\n  'data'\n> & { data: T };\n\nexport interface RequestError<T = any> extends Error {\n  statusCode?: number;\n  data?: T;\n  raw?: RequestSuccessResult<T>;\n}\n\nconst DEFAULT_BASE_URL = 'http://192.168.60.90:3000'; // 192.168.60.78    10.48.75.101\n\nconst getEnvBaseUrl = () => {\n  try {\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n    // @ts-ignore uni-app 会在编译阶段注入 import.meta.env\n    return (import.meta?.env?.VITE_API_BASE_URL as string | undefined) || '';\n  } catch {\n    return '';\n  }\n};\n\nconst BASE_URL = getEnvBaseUrl() || DEFAULT_BASE_URL;\n\nconst isAbsoluteUrl = (url: string) => /^https?:\\/\\//i.test(url);\n\nconst joinUrl = (base: string, path: string) => {\n  if (!base) return path;\n  if (!path) return base;\n  return `${base.replace(/\\/+$/, '')}/${path.replace(/^\\/+/, '')}`;\n};\n\nconst createError = <T>(\n  message: string,\n  res?: RequestSuccessResult<T>\n): RequestError<T> => {\n  const error: RequestError<T> = new Error(message);\n  if (res) {\n    error.statusCode = res.statusCode;\n    error.data = res.data as T;\n    error.raw = res;\n  }\n  return error;\n};\n\nconst getStoredToken = () => {\n  try {\n    const token = uni.getStorageSync('token');\n    return typeof token === 'string' ? token : '';\n  } catch {\n    return '';\n  }\n};\n\nconst coreRequest = <T = any>(options: RequestOptions<T>) => {\n  const {\n    url,\n    showErrorToast = true,\n    baseURL,\n    header = {},\n    ...rest\n  } = options as RequestOptions<T> & Record<string, any>;\n\n  const finalUrl = isAbsoluteUrl(url) ? url : joinUrl(baseURL || BASE_URL, url);\n  const token = getStoredToken();\n  const authHeaders = token\n    ? {\n        Authorization: token.startsWith('Bearer ') ? token : `Bearer ${token}`,\n        token,\n      }\n    : {};\n\n  return new Promise<T>((resolve, reject) => {\n    uni.request({\n      ...rest,\n      url: finalUrl,\n      header: {\n        'Content-Type': 'application/json',\n        ...authHeaders,\n        ...header,\n      },\n      success: (res) => {\n        const typedRes = res as RequestSuccessResult<T>;\n        const success = typedRes.statusCode >= 200 && typedRes.statusCode < 300;\n        if (success) {\n          resolve(typedRes.data);\n          return;\n        }\n\n        const errorPayload =\n          typedRes.data &&\n          typeof typedRes.data === 'object' &&\n          'message' in (typedRes.data as Record<string, any>) &&\n          typeof (typedRes.data as Record<string, any>).message === 'string'\n            ? ((typedRes.data as Record<string, any>).message as string)\n            : `请求失败（${typedRes.statusCode}）`;\n\n        if (showErrorToast) {\n          uni.showToast({\n            title: errorPayload,\n            icon: 'none',\n          });\n        }\n\n        reject(createError(errorPayload, typedRes));\n      },\n      fail: (err) => {\n        if (showErrorToast) {\n          uni.showToast({\n            title: '网络异常，请稍后再试',\n            icon: 'none',\n          });\n        }\n        reject(createError(err.errMsg || 'request fail'));\n      },\n    });\n  });\n};\n\ntype Method = 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH';\n\nconst createShortcut =\n  (method: Method) =>\n  <T = any>(url: string, config?: Omit<RequestOptions<T>, 'url' | 'method'>) =>\n    coreRequest<T>({\n      ...(config as RequestOptions<T>),\n      url,\n      // @ts-expect-error PATCH is a valid method for our backend, but not in uni-app types.\n      method,\n    });\n\nexport const axios = {\n  request: coreRequest,\n  get: createShortcut('GET'),\n  post: createShortcut('POST'),\n  put: createShortcut('PUT'),\n  delete: createShortcut('DELETE'),\n  patch: createShortcut('PATCH'),\n};\n\nexport const request = axios.request;\n\nexport const getBaseUrl = () => BASE_URL;\n"],"names":["uni"],"mappings":";;AAmBA,MAAM,mBAAmB;AAEzB,MAAM,gBAAgB,MAAM;AACtB,MAAA;AAGM,WAA8D;AAAA,EAAA,QAChE;AACC,WAAA;AAAA,EACT;AACF;AAEA,MAAM,WAAW,cAAmB,KAAA;AAEpC,MAAM,gBAAgB,CAAC,QAAgB,gBAAgB,KAAK,GAAG;AAE/D,MAAM,UAAU,CAAC,MAAc,SAAiB;AAC9C,MAAI,CAAC;AAAa,WAAA;AAClB,MAAI,CAAC;AAAa,WAAA;AACX,SAAA,GAAG,KAAK,QAAQ,QAAQ,EAAE,CAAC,IAAI,KAAK,QAAQ,QAAQ,EAAE,CAAC;AAChE;AAEA,MAAM,cAAc,CAClB,SACA,QACoB;AACd,QAAA,QAAyB,IAAI,MAAM,OAAO;AAChD,MAAI,KAAK;AACP,UAAM,aAAa,IAAI;AACvB,UAAM,OAAO,IAAI;AACjB,UAAM,MAAM;AAAA,EACd;AACO,SAAA;AACT;AAEA,MAAM,iBAAiB,MAAM;AACvB,MAAA;AACI,UAAA,QAAQA,cAAAA,MAAI,eAAe,OAAO;AACjC,WAAA,OAAO,UAAU,WAAW,QAAQ;AAAA,EAAA,QACrC;AACC,WAAA;AAAA,EACT;AACF;AAEA,MAAM,cAAc,CAAU,YAA+B;AACrD,QAAA;AAAA,IACJ;AAAA,IACA,iBAAiB;AAAA,IACjB;AAAA,IACA,SAAS,CAAC;AAAA,IACV,GAAG;AAAA,EACD,IAAA;AAEE,QAAA,WAAW,cAAc,GAAG,IAAI,MAAM,QAAQ,WAAW,UAAU,GAAG;AAC5E,QAAM,QAAQ;AACd,QAAM,cAAc,QAChB;AAAA,IACE,eAAe,MAAM,WAAW,SAAS,IAAI,QAAQ,UAAU,KAAK;AAAA,IACpE;AAAA,MAEF;AAEJ,SAAO,IAAI,QAAW,CAAC,SAAS,WAAW;AACzCA,kBAAAA,MAAI,QAAQ;AAAA,MACV,GAAG;AAAA,MACH,KAAK;AAAA,MACL,QAAQ;AAAA,QACN,gBAAgB;AAAA,QAChB,GAAG;AAAA,QACH,GAAG;AAAA,MACL;AAAA,MACA,SAAS,CAAC,QAAQ;AAChB,cAAM,WAAW;AACjB,cAAM,UAAU,SAAS,cAAc,OAAO,SAAS,aAAa;AACpE,YAAI,SAAS;AACX,kBAAQ,SAAS,IAAI;AACrB;AAAA,QACF;AAEM,cAAA,eACJ,SAAS,QACT,OAAO,SAAS,SAAS,YACzB,aAAc,SAAS,QACvB,OAAQ,SAAS,KAA6B,YAAY,WACpD,SAAS,KAA6B,UACxC,QAAQ,SAAS,UAAU;AAEjC,YAAI,gBAAgB;AAClBA,wBAAAA,MAAI,UAAU;AAAA,YACZ,OAAO;AAAA,YACP,MAAM;AAAA,UAAA,CACP;AAAA,QACH;AAEO,eAAA,YAAY,cAAc,QAAQ,CAAC;AAAA,MAC5C;AAAA,MACA,MAAM,CAAC,QAAQ;AACb,YAAI,gBAAgB;AAClBA,wBAAAA,MAAI,UAAU;AAAA,YACZ,OAAO;AAAA,YACP,MAAM;AAAA,UAAA,CACP;AAAA,QACH;AACA,eAAO,YAAY,IAAI,UAAU,cAAc,CAAC;AAAA,MAClD;AAAA,IAAA,CACD;AAAA,EAAA,CACF;AACH;AAIA,MAAM,iBACJ,CAAC,WACD,CAAU,KAAa,WACrB,YAAe;AAAA,EACb,GAAI;AAAA,EACJ;AAAA;AAAA,EAEA;AACF,CAAC;AAEE,MAAM,QAAQ;AAAA,EACnB,SAAS;AAAA,EACT,KAAK,eAAe,KAAK;AAAA,EACzB,MAAM,eAAe,MAAM;AAAA,EAC3B,KAAK,eAAe,KAAK;AAAA,EACzB,QAAQ,eAAe,QAAQ;AAAA,EAC/B,OAAO,eAAe,OAAO;AAC/B;AAIO,MAAM,aAAa,MAAM;;;"}
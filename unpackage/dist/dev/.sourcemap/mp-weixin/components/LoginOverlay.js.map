{"version":3,"file":"LoginOverlay.js","sources":["components/LoginOverlay.vue","../../../App/hbuilder/HBuilderX/plugins/uniapp-cli-vite/uniComponent:/RDovTGVhcm4vcHJvamVjdEZpbGUvY2F0LWxpZmUtdW5pYXBwLXdlY2hhdC9jb21wb25lbnRzL0xvZ2luT3ZlcmxheS52dWU"],"sourcesContent":["<template>\n  <view\n    v-if=\"visible\"\n    class=\"login-overlay\"\n    @tap=\"closeSheet\"\n    @touchmove.stop.prevent\n  >\n    <view class=\"login-overlay__backdrop\"></view>\n    <view class=\"login-sheet\" @tap.stop>\n      <view class=\"login-sheet__close\" @tap=\"closeSheet\">✕</view>\n      <view class=\"login-sheet__title\">登录账号</view>\n      <view class=\"login-sheet__subtitle\">为有效保存您的数据，建议您登录</view>\n      <button\n        class=\"login-sheet__btn login-sheet__btn--wechat\"\n        :loading=\"isSubmitting\"\n        :disabled=\"isSubmitting\"\n        @tap=\"handleWeChatLogin\"\n      >\n        微信一键登录\n      </button>\n      <view class=\"login-sheet__agreement\" @tap=\"toggleAgreement\">\n        <view class=\"checkbox\" :class=\"{ 'checkbox--checked': hasAgreed }\">\n          <text v-if=\"hasAgreed\">✓</text>\n        </view>\n        <view class=\"agreement-text\">\n          我已阅读并同意\n          <text class=\"agreement-link\" @tap.stop=\"openAgreement('user')\">小熊油耗助手用户使用协议</text>\n          和\n          <text class=\"agreement-link\" @tap.stop=\"openAgreement('privacy')\">隐私保护协议</text>\n        </view>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script setup lang=\"ts\">\nimport { ref, watch } from 'vue'\nimport { useAuth } from '@/utils/auth'\n\nconst props = defineProps<{\n  visible: boolean\n}>()\n\nconst emit = defineEmits<{\n  (e: 'update:visible', value: boolean): void\n  (e: 'login-success'): void\n}>()\n\nconst hasAgreed = ref(false)\nconst isSubmitting = ref(false)\nconst { refreshLoginState } = useAuth()\n\nwatch(\n  () => props.visible,\n  (visible) => {\n    if (!visible) {\n      hasAgreed.value = false\n      isSubmitting.value = false\n    }\n  }\n)\n\nconst closeSheet = () => {\n  emit('update:visible', false)\n}\n\nconst toggleAgreement = () => {\n  hasAgreed.value = !hasAgreed.value\n}\n\nconst openAgreement = (type: 'user' | 'privacy') => {\n  const name = type === 'user' ? '用户使用协议' : '隐私保护协议'\n  uni.showToast({\n    title: `${name}暂未上线`,\n    icon: 'none'\n  })\n}\n\nconst handleWeChatLogin = () => {\n  if (isSubmitting.value) {\n    return\n  }\n  if (!hasAgreed.value) {\n    uni.showToast({\n      title: '请勾选协议后再登录',\n      icon: 'none'\n    })\n    return\n  }\n\n  isSubmitting.value = true\n  uni.getUserProfile({\n    desc: '用于完善个人信息',\n    success: (profileRes) => {\n      const userInfo = profileRes.userInfo\n      uni.login({\n        provider: 'weixin',\n        success: (loginRes) => {\n          const code = loginRes.code\n          uni.request({\n            url: 'http://192.168.60.58:3000/api/auth/login',\n            method: 'POST',\n            header: {\n              'Content-Type': 'application/json'\n            },\n            data: {\n              code,\n              userInfo\n            },\n            success: (res) => {\n              isSubmitting.value = false\n              if (res.statusCode !== 200) {\n                uni.showToast({ title: '登录失败', icon: 'none' })\n                return\n              }\n\n              const { token, user } = res.data as { token?: string; user?: Record<string, any> }\n              if (token) {\n                uni.setStorageSync('token', token)\n              }\n              if (user) {\n                uni.setStorageSync('userInfo', user)\n              }\n\n              refreshLoginState()\n              uni.showToast({ title: '登录成功', icon: 'success' })\n              emit('login-success')\n              emit('update:visible', false)\n            },\n            fail: () => {\n              isSubmitting.value = false\n              uni.showToast({ title: '网络错误', icon: 'none' })\n            }\n          })\n        },\n        fail: () => {\n          isSubmitting.value = false\n          uni.showToast({ title: '微信登录失败', icon: 'none' })\n        }\n      })\n    },\n    fail: (err) => {\n      isSubmitting.value = false\n      uni.__f__('log','at components/LoginOverlay.vue:144','getUserProfile fail', err)\n      uni.showToast({ title: '需要授权头像信息', icon: 'none' })\n    }\n  })\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.login-overlay {\n  position: fixed;\n  inset: 0;\n  z-index: 1000;\n  display: flex;\n  align-items: flex-end;\n  justify-content: center;\n}\n\n.login-overlay__backdrop {\n  position: absolute;\n  inset: 0;\n  background: rgba(14, 21, 37, 0.55);\n  backdrop-filter: blur(6px);\n}\n\n.login-sheet {\n  position: relative;\n  width: 100%;\n  border-top-left-radius: 40rpx;\n  border-top-right-radius: 40rpx;\n  background: #fff;\n  padding: 48rpx 40rpx calc(48rpx + env(safe-area-inset-bottom, 0));\n  box-shadow: 0 -20rpx 40rpx rgba(7, 18, 38, 0.15);\n  animation: slideUp 0.3s ease-out;\n}\n\n.login-sheet__close {\n  position: absolute;\n  right: 36rpx;\n  top: 32rpx;\n  width: 64rpx;\n  height: 64rpx;\n  border-radius: 50%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: rgba(20, 32, 58, 0.04);\n  font-size: 32rpx;\n  color: #5f6c7b;\n}\n\n.login-sheet__title {\n  font-size: 36rpx;\n  font-weight: 700;\n  color: #121d2c;\n}\n\n.login-sheet__subtitle {\n  margin-top: 12rpx;\n  font-size: 26rpx;\n  color: #6c778a;\n}\n\n.login-sheet__btn {\n  margin-top: 40rpx;\n  width: 100%;\n  height: 96rpx;\n  line-height: 96rpx;\n  border-radius: 999rpx;\n  font-size: 32rpx;\n  font-weight: 600;\n  color: #fff;\n  border: none;\n}\n\n.login-sheet__btn--wechat {\n  background: linear-gradient(110deg, #2dd881, #13a853);\n  box-shadow: 0 24rpx 36rpx rgba(19, 168, 83, 0.35);\n}\n\n.login-sheet__agreement {\n  margin-top: 32rpx;\n  display: flex;\n  gap: 16rpx;\n  align-items: center;\n}\n\n.checkbox {\n  width: 32rpx;\n  height: 32rpx;\n  border: 2rpx solid rgba(20, 32, 58, 0.2);\n  border-radius: 8rpx;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  color: #fff;\n  font-size: 24rpx;\n}\n\n.checkbox--checked {\n  background: #1ec15f;\n  border-color: #1ec15f;\n}\n\n.agreement-text {\n  flex: 1;\n  font-size: 24rpx;\n  color: #7b8697;\n  line-height: 1.5;\n}\n\n.agreement-link {\n  color: #1ec15f;\n}\n\n@keyframes slideUp {\n  0% {\n    transform: translateY(20%);\n    opacity: 0;\n  }\n  100% {\n    transform: translateY(0);\n    opacity: 1;\n  }\n}\n</style>\n","import Component from 'D:/Learn/projectFile/cat-life-uniapp-wechat/components/LoginOverlay.vue'\nwx.createComponent(Component)"],"names":["ref","useAuth","watch","uni"],"mappings":";;;;;;;;;;AAuCA,UAAM,QAAQ;AAId,UAAM,OAAO;AAKP,UAAA,YAAYA,kBAAI,KAAK;AACrB,UAAA,eAAeA,kBAAI,KAAK;AACxB,UAAA,EAAE,sBAAsBC,WAAAA;AAE9BC,kBAAA;AAAA,MACE,MAAM,MAAM;AAAA,MACZ,CAAC,YAAY;AACX,YAAI,CAAC,SAAS;AACZ,oBAAU,QAAQ;AAClB,uBAAa,QAAQ;AAAA,QACvB;AAAA,MACF;AAAA,IAAA;AAGF,UAAM,aAAa,MAAM;AACvB,WAAK,kBAAkB,KAAK;AAAA,IAAA;AAG9B,UAAM,kBAAkB,MAAM;AAClB,gBAAA,QAAQ,CAAC,UAAU;AAAA,IAAA;AAGzB,UAAA,gBAAgB,CAAC,SAA6B;AAC5C,YAAA,OAAO,SAAS,SAAS,WAAW;AAC1CC,oBAAAA,MAAI,UAAU;AAAA,QACZ,OAAO,GAAG,IAAI;AAAA,QACd,MAAM;AAAA,MAAA,CACP;AAAA,IAAA;AAGH,UAAM,oBAAoB,MAAM;AAC9B,UAAI,aAAa,OAAO;AACtB;AAAA,MACF;AACI,UAAA,CAAC,UAAU,OAAO;AACpBA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,QAAA,CACP;AACD;AAAA,MACF;AAEA,mBAAa,QAAQ;AACrBA,oBAAAA,MAAI,eAAe;AAAA,QACjB,MAAM;AAAA,QACN,SAAS,CAAC,eAAe;AACvB,gBAAM,WAAW,WAAW;AAC5BA,wBAAAA,MAAI,MAAM;AAAA,YACR,UAAU;AAAA,YACV,SAAS,CAAC,aAAa;AACrB,oBAAM,OAAO,SAAS;AACtBA,4BAAAA,MAAI,QAAQ;AAAA,gBACV,KAAK;AAAA,gBACL,QAAQ;AAAA,gBACR,QAAQ;AAAA,kBACN,gBAAgB;AAAA,gBAClB;AAAA,gBACA,MAAM;AAAA,kBACJ;AAAA,kBACA;AAAA,gBACF;AAAA,gBACA,SAAS,CAAC,QAAQ;AAChB,+BAAa,QAAQ;AACjB,sBAAA,IAAI,eAAe,KAAK;AAC1BA,kCAAA,MAAI,UAAU,EAAE,OAAO,QAAQ,MAAM,QAAQ;AAC7C;AAAA,kBACF;AAEA,wBAAM,EAAE,OAAO,SAAS,IAAI;AAC5B,sBAAI,OAAO;AACLA,kCAAAA,MAAA,eAAe,SAAS,KAAK;AAAA,kBACnC;AACA,sBAAI,MAAM;AACJA,kCAAAA,MAAA,eAAe,YAAY,IAAI;AAAA,kBACrC;AAEkB;AAClBA,gCAAA,MAAI,UAAU,EAAE,OAAO,QAAQ,MAAM,WAAW;AAChD,uBAAK,eAAe;AACpB,uBAAK,kBAAkB,KAAK;AAAA,gBAC9B;AAAA,gBACA,MAAM,MAAM;AACV,+BAAa,QAAQ;AACrBA,gCAAA,MAAI,UAAU,EAAE,OAAO,QAAQ,MAAM,QAAQ;AAAA,gBAC/C;AAAA,cAAA,CACD;AAAA,YACH;AAAA,YACA,MAAM,MAAM;AACV,2BAAa,QAAQ;AACrBA,4BAAA,MAAI,UAAU,EAAE,OAAO,UAAU,MAAM,QAAQ;AAAA,YACjD;AAAA,UAAA,CACD;AAAA,QACH;AAAA,QACA,MAAM,CAAC,QAAQ;AACb,uBAAa,QAAQ;AACrBA,wBAAA,MAAI,MAAM,OAAM,sCAAqC,uBAAuB,GAAG;AAC/EA,wBAAA,MAAI,UAAU,EAAE,OAAO,YAAY,MAAM,QAAQ;AAAA,QACnD;AAAA,MAAA,CACD;AAAA,IAAA;;;;;;;;;;;;;;;;;;;;;;;;;ACjJH,GAAG,gBAAgB,SAAS;"}